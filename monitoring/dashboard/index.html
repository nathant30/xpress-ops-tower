<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xpress Ops Tower - Performance Dashboard</title>
    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f6fa;
            color: #2c3e50;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header h1 {
            font-size: 1.8rem;
            font-weight: 300;
        }
        
        .header .status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #2ecc71;
            animation: pulse 2s infinite;
        }
        
        .status-indicator.warning {
            background: #f39c12;
        }
        
        .status-indicator.critical {
            background: #e74c3c;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 1.5rem;
            padding: 2rem;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .widget {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border: 1px solid #e1e8ed;
        }
        
        .widget h3 {
            font-size: 1.2rem;
            margin-bottom: 1rem;
            color: #2c3e50;
            font-weight: 500;
        }
        
        .metric-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 0.5rem;
        }
        
        .metric-label {
            color: #7f8c8d;
            font-size: 0.9rem;
        }
        
        .alert-widget {
            grid-column: span 3;
            background: #fff5f5;
            border-left: 4px solid #e74c3c;
        }
        
        .alert-widget.no-alerts {
            background: #f0fff4;
            border-left-color: #2ecc71;
        }
        
        .alert {
            background: white;
            border: 1px solid #fed7d7;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.5rem;
        }
        
        .alert.critical {
            border-color: #feb2b2;
            background: #fed7d7;
        }
        
        .alert.warning {
            border-color: #fbd38d;
            background: #fef5e7;
        }
        
        .chart-widget {
            grid-column: span 2;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }
        
        .metric-card {
            background: #f8f9ff;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .metric-card .value {
            font-size: 1.5rem;
            font-weight: 600;
            color: #667eea;
        }
        
        .metric-card .label {
            font-size: 0.8rem;
            color: #7f8c8d;
            margin-top: 0.5rem;
        }
        
        .emergency-widget {
            border-left: 4px solid #e74c3c;
        }
        
        .emergency-metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #ecf0f1;
        }
        
        .emergency-metric:last-child {
            border-bottom: none;
        }
        
        .controls {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            display: flex;
            gap: 1rem;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            background: #667eea;
            color: white;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.2s;
        }
        
        .btn:hover {
            background: #5a67d8;
        }
        
        .btn.secondary {
            background: #718096;
        }
        
        .btn.secondary:hover {
            background: #4a5568;
        }
        
        .timestamp {
            font-size: 0.8rem;
            color: #7f8c8d;
            margin-top: 0.5rem;
        }
        
        @media (max-width: 1024px) {
            .dashboard {
                grid-template-columns: 1fr 1fr;
            }
            
            .chart-widget {
                grid-column: span 2;
            }
            
            .alert-widget {
                grid-column: span 2;
            }
        }
        
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
                padding: 1rem;
            }
            
            .chart-widget,
            .alert-widget {
                grid-column: span 1;
            }
            
            .header {
                padding: 1rem;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üöÄ Xpress Ops Tower - Performance Dashboard</h1>
        <div class="status">
            <div class="status-indicator" id="statusIndicator"></div>
            <span id="statusText">System Healthy</span>
            <span class="timestamp" id="lastUpdate">Last updated: --</span>
        </div>
    </div>
    
    <div class="dashboard">
        <!-- System Metrics -->
        <div class="widget">
            <h3>üíª CPU Usage</h3>
            <div class="metric-value" id="cpuUsage">--</div>
            <div class="metric-label">Percentage</div>
            <div class="timestamp" id="cpuTimestamp">--</div>
        </div>
        
        <div class="widget">
            <h3>üß† Memory Usage</h3>
            <div class="metric-value" id="memoryUsage">--</div>
            <div class="metric-label">Percentage</div>
            <div class="timestamp" id="memoryTimestamp">--</div>
        </div>
        
        <div class="widget">
            <h3>üåê WebSocket Connections</h3>
            <div class="metric-value" id="wsConnections">--</div>
            <div class="metric-label">Active connections</div>
            <div class="timestamp" id="wsTimestamp">--</div>
        </div>
        
        <!-- Emergency System Metrics -->
        <div class="widget emergency-widget">
            <h3>üö® Emergency System</h3>
            <div class="emergency-metric">
                <span>Avg Response Time</span>
                <strong id="emergencyResponseTime">-- ms</strong>
            </div>
            <div class="emergency-metric">
                <span>Success Rate</span>
                <strong id="emergencySuccessRate">--%</strong>
            </div>
            <div class="emergency-metric">
                <span>Active Alerts</span>
                <strong id="activeEmergencies">--</strong>
            </div>
        </div>
        
        <div class="widget">
            <h3>üöó Active Drivers</h3>
            <div class="metric-value" id="activeDrivers">--</div>
            <div class="metric-label">Online drivers</div>
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="value" id="busyDrivers">--</div>
                    <div class="label">Busy</div>
                </div>
                <div class="metric-card">
                    <div class="value" id="emergencyDrivers">--</div>
                    <div class="label">Emergency</div>
                </div>
            </div>
        </div>
        
        <div class="widget">
            <h3>üìã Active Bookings</h3>
            <div class="metric-value" id="activeBookings">--</div>
            <div class="metric-label">Current bookings</div>
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="value" id="completedToday">--</div>
                    <div class="label">Completed today</div>
                </div>
            </div>
        </div>
        
        <!-- Performance Chart -->
        <div class="widget chart-widget">
            <h3>üìà Performance Trends</h3>
            <div class="chart-container">
                <canvas id="performanceChart"></canvas>
            </div>
        </div>
        
        <!-- Database Metrics -->
        <div class="widget">
            <h3>üóÑÔ∏è Database Performance</h3>
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="value" id="dbConnections">--</div>
                    <div class="label">Active Connections</div>
                </div>
                <div class="metric-card">
                    <div class="value" id="dbQueries">--</div>
                    <div class="label">Queries/sec</div>
                </div>
                <div class="metric-card">
                    <div class="value" id="dbResponseTime">--</div>
                    <div class="label">Avg Response (ms)</div>
                </div>
            </div>
        </div>
        
        <!-- Alerts -->
        <div class="widget alert-widget" id="alertsWidget">
            <h3>üîî System Alerts</h3>
            <div id="alertsContainer">
                <div class="alert-placeholder">No active alerts - system running smoothly</div>
            </div>
        </div>
    </div>
    
    <div class="controls">
        <button class="btn secondary" onclick="exportMetrics('json')">Export JSON</button>
        <button class="btn secondary" onclick="exportMetrics('csv')">Export CSV</button>
        <button class="btn" onclick="refreshDashboard()">Refresh</button>
    </div>
    
    <script>
        class PerformanceDashboard {
            constructor() {
                this.socket = io();
                this.performanceChart = null;
                this.chartData = {
                    labels: [],
                    datasets: [
                        {
                            label: 'CPU Usage (%)',
                            data: [],
                            borderColor: '#e74c3c',
                            backgroundColor: 'rgba(231, 76, 60, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'Memory Usage (%)',
                            data: [],
                            borderColor: '#3498db',
                            backgroundColor: 'rgba(52, 152, 219, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'Emergency Response (s)',
                            data: [],
                            borderColor: '#f39c12',
                            backgroundColor: 'rgba(243, 156, 18, 0.1)',
                            tension: 0.4,
                            yAxisID: 'y1'
                        }
                    ]
                };
                
                this.initializeChart();
                this.setupWebSocket();
                this.loadInitialData();
            }
            
            initializeChart() {
                const ctx = document.getElementById('performanceChart').getContext('2d');
                this.performanceChart = new Chart(ctx, {
                    type: 'line',
                    data: this.chartData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                min: 0,
                                max: 100
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                min: 0,
                                max: 10,
                                grid: {
                                    drawOnChartArea: false,
                                }
                            }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: 'System Performance Over Time'
                            }
                        }
                    }
                });
            }
            
            setupWebSocket() {
                this.socket.on('connect', () => {
                    console.log('Connected to metrics dashboard');
                    this.updateStatus('healthy', 'Connected');
                });
                
                this.socket.on('disconnect', () => {
                    console.log('Disconnected from metrics dashboard');
                    this.updateStatus('warning', 'Disconnected');
                });
                
                this.socket.on('initial-metrics', (data) => {
                    this.updateMetrics(data);
                });
                
                this.socket.on('metrics-update', (data) => {
                    this.updateMetrics(data);
                    this.updateChart(data);
                });
                
                this.socket.on('new-alert', (alert) => {
                    this.addAlert(alert);
                    this.updateStatus('warning', 'Alerts active');
                });
                
                this.socket.on('alerts-update', (alerts) => {
                    this.updateAlerts(alerts);
                });
                
                this.socket.on('monitoring-error', (error) => {
                    console.error('Monitoring error:', error);
                    this.updateStatus('critical', 'Monitoring error');
                });
            }
            
            async loadInitialData() {
                try {
                    // Load current metrics
                    const metricsResponse = await fetch('/api/metrics');
                    const metricsData = await metricsResponse.json();
                    if (metricsData.success) {
                        this.updateMetrics(metricsData.data);
                    }
                    
                    // Load alerts
                    const alertsResponse = await fetch('/api/alerts');
                    const alertsData = await alertsResponse.json();
                    if (alertsData.success) {
                        this.updateAlerts(alertsData.data);
                    }
                    
                    // Load historical data for chart
                    const historyResponse = await fetch('/api/metrics/history?hours=1');
                    const historyData = await historyResponse.json();
                    if (historyData.success && historyData.data.length > 0) {
                        this.initializeChartData(historyData.data);
                    }
                } catch (error) {
                    console.error('Failed to load initial data:', error);
                    this.updateStatus('critical', 'Failed to load data');
                }
            }
            
            updateMetrics(data) {
                if (!data || !data.metrics) return;
                
                const metrics = data.metrics;
                
                // Update timestamp
                document.getElementById('lastUpdate').textContent = 
                    `Last updated: ${new Date(data.timestamp).toLocaleTimeString()}`;
                
                // System metrics
                if (metrics.system) {
                    this.updateElement('cpuUsage', metrics.system.cpu?.usage_percent, '%', 1);
                    this.updateElement('memoryUsage', metrics.system.memory?.usage_percent, '%', 1);
                }
                
                // WebSocket metrics
                if (metrics.websocket) {
                    this.updateElement('wsConnections', metrics.websocket.connections?.totalConnections, '', 0);
                }
                
                // Emergency metrics
                if (metrics.emergency) {
                    this.updateElement('emergencyResponseTime', 
                        metrics.emergency.sos_processing?.average_processing_time_ms, ' ms', 0);
                    this.updateElement('emergencySuccessRate', 
                        metrics.emergency.sos_processing?.success_rate, '%', 1);
                    this.updateElement('activeEmergencies', 
                        metrics.emergency.critical_alerts?.active_count, '', 0);
                }
                
                // Business metrics
                if (metrics.business) {
                    this.updateElement('activeDrivers', metrics.business.drivers?.online, '', 0);
                    this.updateElement('busyDrivers', metrics.business.drivers?.busy, '', 0);
                    this.updateElement('emergencyDrivers', metrics.business.drivers?.emergency, '', 0);
                    this.updateElement('activeBookings', metrics.business.bookings?.active, '', 0);
                    this.updateElement('completedToday', metrics.business.bookings?.completed_today, '', 0);
                }
                
                // Database metrics
                if (metrics.database) {
                    this.updateElement('dbConnections', metrics.database.connection_pool?.active_connections, '', 0);
                    this.updateElement('dbQueries', metrics.database.query_performance?.queries_per_second, '', 0);
                    this.updateElement('dbResponseTime', metrics.database.query_performance?.average_query_time_ms, '', 1);
                }
            }
            
            updateElement(id, value, suffix = '', decimals = 0) {
                const element = document.getElementById(id);
                if (element && value !== undefined && value !== null) {
                    const formattedValue = typeof value === 'number' 
                        ? value.toFixed(decimals) 
                        : value.toString();
                    element.textContent = formattedValue + suffix;
                }
            }
            
            updateStatus(level, message) {
                const indicator = document.getElementById('statusIndicator');
                const text = document.getElementById('statusText');
                
                indicator.className = `status-indicator ${level}`;
                text.textContent = message;
            }
            
            updateChart(data) {
                if (!data || !data.metrics) return;
                
                const timestamp = new Date(data.timestamp).toLocaleTimeString();
                const maxDataPoints = 20;
                
                // Add new data point
                this.chartData.labels.push(timestamp);
                
                // CPU usage
                const cpuUsage = data.metrics.system?.cpu?.usage_percent || 0;
                this.chartData.datasets[0].data.push(cpuUsage);
                
                // Memory usage
                const memoryUsage = data.metrics.system?.memory?.usage_percent || 0;
                this.chartData.datasets[1].data.push(memoryUsage);
                
                // Emergency response time (converted to seconds)
                const emergencyTime = (data.metrics.emergency?.sos_processing?.average_processing_time_ms || 0) / 1000;
                this.chartData.datasets[2].data.push(emergencyTime);
                
                // Keep only the last N data points
                if (this.chartData.labels.length > maxDataPoints) {
                    this.chartData.labels.shift();
                    this.chartData.datasets.forEach(dataset => dataset.data.shift());
                }
                
                this.performanceChart.update('none');
            }
            
            initializeChartData(historyData) {
                historyData.slice(-20).forEach(snapshot => {
                    const timestamp = new Date(snapshot.timestamp).toLocaleTimeString();
                    this.chartData.labels.push(timestamp);
                    
                    const cpuUsage = snapshot.metrics.system?.cpu?.usage_percent || 0;
                    this.chartData.datasets[0].data.push(cpuUsage);
                    
                    const memoryUsage = snapshot.metrics.system?.memory?.usage_percent || 0;
                    this.chartData.datasets[1].data.push(memoryUsage);
                    
                    const emergencyTime = (snapshot.metrics.emergency?.sos_processing?.average_processing_time_ms || 0) / 1000;
                    this.chartData.datasets[2].data.push(emergencyTime);
                });
                
                this.performanceChart.update();
            }
            
            updateAlerts(alerts) {
                const container = document.getElementById('alertsContainer');
                const widget = document.getElementById('alertsWidget');
                
                if (!alerts || alerts.length === 0) {
                    container.innerHTML = '<div class="alert-placeholder">No active alerts - system running smoothly</div>';
                    widget.className = 'widget alert-widget no-alerts';
                    return;
                }
                
                widget.className = 'widget alert-widget';
                container.innerHTML = alerts.map(alert => `
                    <div class="alert ${alert.severity}">
                        <strong>${alert.type.replace(/_/g, ' ').toUpperCase()}</strong>: ${alert.message}
                        <div class="timestamp">${new Date(alert.timestamp).toLocaleString()}</div>
                    </div>
                `).join('');
            }
            
            addAlert(alert) {
                const container = document.getElementById('alertsContainer');
                const widget = document.getElementById('alertsWidget');
                
                // Remove placeholder if exists
                const placeholder = container.querySelector('.alert-placeholder');
                if (placeholder) {
                    placeholder.remove();
                    widget.className = 'widget alert-widget';
                }
                
                // Add new alert at the top
                const alertElement = document.createElement('div');
                alertElement.className = `alert ${alert.severity}`;
                alertElement.innerHTML = `
                    <strong>${alert.type.replace(/_/g, ' ').toUpperCase()}</strong>: ${alert.message}
                    <div class="timestamp">${new Date(alert.timestamp).toLocaleString()}</div>
                `;
                
                container.insertBefore(alertElement, container.firstChild);
                
                // Keep only the last 10 alerts
                const alerts = container.querySelectorAll('.alert');
                if (alerts.length > 10) {
                    alerts[alerts.length - 1].remove();
                }
            }
        }
        
        // Global functions
        function refreshDashboard() {
            location.reload();
        }
        
        function exportMetrics(format) {
            const link = document.createElement('a');
            link.href = `/api/export/${format}`;
            link.download = `xpress-metrics-${new Date().toISOString().slice(0, 10)}.${format}`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new PerformanceDashboard();
        });
    </script>
</body>
</html>